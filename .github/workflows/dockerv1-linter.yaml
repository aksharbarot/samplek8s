# .github/workflows/docker-lint-and-trivy.yaml
name: Docker Lint & Trivy Scan

on:
  push:
    paths:
      - '**/Dockerfile*'
  pull_request:
    paths:
      - '**/Dockerfile*'
  workflow_dispatch:

jobs:
  lint-and-build:
    runs-on: ubuntu-latest
    outputs:
      lint_failed: ${{ steps.scan.outputs.fail_code }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare reports dir
        run: mkdir -p reports

      - name: Install Hadolint
        run: |
          wget -O /usr/local/bin/hadolint \
            https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Lint & Build Dockerfiles
        id: scan
        run: |
          set -e
          FAIL=0
          > image_list.txt

          for file in $(find . -type f -name 'Dockerfile*' ! -path "./reports/*"); do
            base=$(basename "$file")
            tag="localscan-${base,,}"
            ctx=$(dirname "$file")

            echo "ðŸ” Linting $file"
            hadolint "$file" --ignore DL3018 > "reports/${base}_lint.txt" || true
            if [ -s "reports/${base}_lint.txt" ]; then
              echo "âŒ Hadolint found issues in $file"
              FAIL=1
            fi

            echo "ðŸ³ Building $file â†’ $tag"
            if docker build -f "$file" -t "$tag" "$ctx" \
               > "reports/${base}_build.txt" 2>&1; then
              echo "$file" >> image_list.txt
            else
              echo "âŒ Build failed for $file"
              cat "reports/${base}_build.txt"
              FAIL=1
            fi
          done

          echo "fail_code=$FAIL" >> $GITHUB_OUTPUT

      - name: Upload lint + build reports
        uses: actions/upload-artifact@v4
        with:
          name: docker-reports
          path: reports/

      - name: Upload image list
        uses: actions/upload-artifact@v4
        with:
          name: image-list
          path: image_list.txt

      - name: Fail if lint or build errors
        if: ${{ steps.scan.outputs.fail_code == '1' }}
        run: exit 1

  trivy-scan:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Download image list
        uses: actions/download-artifact@v4
        with:
          name: image-list
          path: image-list

      - name: Rebuild & collect tags
        run: |
          mkdir -p image-list
          > image-list/image_tags.txt

          if [[ ! -s image-list/image_list.txt ]]; then
            echo "âŒ No Dockerfiles to scan"
            exit 1
          fi

          while read -r file; do
            base=$(basename "$file")
            tag="localscan-${base,,}"
            ctx=$(dirname "$file")
            echo "ðŸ³ Rebuilding $file â†’ $tag"
            docker build -f "$file" -t "$tag" "$ctx"
            echo "$tag" >> image-list/image_tags.txt
          done < image-list/image_list.txt

      - name: Run Trivy on each image
        run: |
          mkdir -p reports
          > reports/trivy_warnings.log

          while read -r img; do
            echo "ðŸ” Scanning $img"
            # --exit-code 1 makes trivy return code 1 if any CVEs at specified severities
            trivy image \
              --severity CRITICAL,HIGH,MEDIUM \
              --ignore-unfixed \
              --exit-code 1 \
              --format json \
              "$img" \
              > "reports/${img//\//_}.json" \
              2>> reports/trivy_warnings.log || true
          done < image-list/image_tags.txt

      - name: Warn if unsupported OS warnings showed up
        run: |
          if grep -q "no longer supported by the distribution" reports/trivy_warnings.log; then
            echo "âš ï¸  Trivy emitted unsupported-OS warnings, but we'll continue"
          else
            echo "âœ… No unsupported-OS warnings"
          fi

      - name: Aggregate & Fail on CVEs
        run: |
          COUNT=$(jq '[.[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")] | length' reports/*.json)
          echo "ðŸ§ª Found $COUNT CRITICAL/HIGH/MEDIUM vulnerabilities"
          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ Vulnerabilities detected!"
            exit 1
          else
            echo "âœ… No critical/high/medium vulnerabilities"
          fi

name: Docker Lint & Trivy Scan

on:
  push:
    paths:
      - '**/Dockerfile*'
  pull_request:
    paths:
      - '**/Dockerfile*'
  workflow_dispatch:

jobs:
  lint-and-build:
    runs-on: ubuntu-latest

    outputs:
      lint_failed: ${{ steps.scan.outputs.fail_code }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: mkdir -p reports images

      - name: Install Hadolint
        run: |
          wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Install Trivy (optional for testing builds)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Lint, Build, and Save Docker images
        id: scan
        run: |
          set -e
          FAIL=0
          > image_list.txt

          for file in $(find . -type f -name 'Dockerfile*' ! -path "./reports/*"); do
            echo "‚ñ∂Ô∏è Found Dockerfile: $file"
            base=$(basename "$file")
            image_tag="localscan-${base,,}"
            context_dir=$(dirname "$file")

            echo "üîç Linting $file"
            hadolint "$file" --ignore DL3018 > "reports/${base}_hadolint.txt" || true
            if grep -q . "reports/${base}_hadolint.txt"; then
              echo "‚ùå Lint issues in $file"
              FAIL=1
            fi

            echo "üê≥ Building image: $image_tag"
            if docker build -f "$file" -t "$image_tag" "$context_dir" > "reports/${base}_build.txt" 2>&1; then
              echo "$image_tag" >> image_list.txt
              docker save "$image_tag" -o "images/${image_tag}.tar"
            else
              echo "‚ùå Build failed for $file"
              cat "reports/${base}_build.txt"
              FAIL=1
            fi
          done

          echo "fail_code=$FAIL" >> $GITHUB_OUTPUT

      - name: Upload built images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            images/
            image_list.txt

      - name: Upload lint/build reports
        uses: actions/upload-artifact@v4
        with:
          name: docker-reports
          path: reports/

      - name: Fail if lint or build errors found
        if: steps.scan.outputs.fail_code == '1'
        run: |
          echo "‚ùå Lint or build errors detected"
          exit 1

  trivy-scan:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: images

      - name: Load Docker images
        run: |
          for tar in images/*.tar; do
            docker load -i "$tar"
          done

      - name: Run Trivy scan and generate JSON
        run: |
          mkdir -p reports
          while read -r image; do
            echo "üîç Scanning image: $image"
            trivy image --format json --ignore-unfixed --severity CRITICAL,HIGH,MEDIUM "$image" > "reports/trivy_${image}.json"
          done < images/image_list.txt
          jq -s '.' reports/trivy_*.json > reports/trivy_combined.json

      - name: Upload Trivy scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: reports/trivy_combined.json

      - name: Convert Trivy JSON to annotation format
        run: |
          jq -n '
            [inputs[] | select(.Vulnerabilities) | .Vulnerabilities[]? |
              {
                path: "Dockerfile",
                start_line: 1,
                end_line: 1,
                annotation_level: (if .Severity == "CRITICAL" then "failure" elif .Severity == "HIGH" then "warning" else "notice" end),
                message: (.VulnerabilityID + " in " + .PkgName + " ‚Äì " + .PrimaryURL),
                title: "Trivy Scan"
              }
            ]
          ' reports/trivy_combined.json > reports/annotations.json

      - name: Annotate Trivy issues with ::warning (fallback)
        run: |
          jq -c '.[]' reports/annotations.json | while read -r ann; do
            FILE=$(echo "$ann" | jq -r .path)
            LINE=$(echo "$ann" | jq -r .start_line)
            LEVEL=$(echo "$ann" | jq -r .annotation_level)
            TITLE=$(echo "$ann" | jq -r .title)
            MESSAGE=$(echo "$ann" | jq -r .message)
            echo "::${LEVEL} file=${FILE},line=${LINE},title=${TITLE}::$MESSAGE"
          done

      - name: Inline Trivy warnings (non-PR fallback)
        if: github.event_name != 'pull_request'
        run: |
          jq -c '.[] | select(.Vulnerabilities) | .Vulnerabilities[]' reports/trivy_combined.json | while read -r vuln; do
            ID=$(echo "$vuln" | jq -r .VulnerabilityID)
            PACKAGE=$(echo "$vuln" | jq -r .PkgName)
            SEVERITY=$(echo "$vuln" | jq -r .Severity)
            URL=$(echo "$vuln" | jq -r .PrimaryURL)
            echo "::warning file=Dockerfile,line=1,title=Trivy::$ID in $PACKAGE ‚Äì Severity: $SEVERITY ‚Äì $URL"
          done

      - name: Fail if vulnerabilities found
        run: |
          COUNT=$(jq '[.[] | .Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH" or .Severity == "MEDIUM")] | length' reports/trivy_combined.json)
          echo "üß™ Found $COUNT vulnerabilities"
          if [ "$COUNT" -gt 0 ]; then
            echo "‚ùå Vulnerabilities found"
            exit 1
          else
            echo "‚úÖ No critical/high/medium vulnerabilities"
          fi
